###Flsun Super Racer printer config####

[mcu]
serial: /dev/serial/by-id/usb-Klipper_lpc1769_0E80FF0AC0846AAF99CA555EC02000F5-if00

[printer]
kinematics: delta
max_velocity: 7000
max_accel: 4800
max_z_velocity: 2000
minimum_z_position: -5
square_corner_velocity: 15.0
#delta_radius: 150
print_radius: 131 # print area is 260mm diameter


###Stepper X config###
[stepper_a]
step_pin: P2.2
dir_pin: P2.6
enable_pin: !P2.1
microsteps: 128
rotation_distance: 40
endstop_pin: P1.29
#position_endstop: 336
#arm_length: 315.0

homing_speed: 80 # can bump this to maybe 90
second_homing_speed: 5
homing_retract_dist: 5.0
homing_retract_speed:10

[tmc2209 stepper_a]
uart_pin: P1.10
run_current: 0.850
interpolate: false


###Stepper Y config###
[stepper_b]
step_pin: P0.19
dir_pin: P0.20
enable_pin: !P2.8
microsteps: 128
rotation_distance: 40
endstop_pin: P1.28 
#position_endstop: 336
#arm_length: 315.0

[tmc2209 stepper_b]
uart_pin: P1.9
run_current: 0.850
interpolate: false


###Stepper Z config###
[stepper_c]
step_pin: P0.22
dir_pin: P2.11
enable_pin: !P0.21
microsteps: 128
rotation_distance: 40
endstop_pin: P1.27  
#position_endstop: 336
#arm_length: 315.0

[tmc2209 stepper_c]
uart_pin: P1.8
run_current: 0.850
interpolate: false

[extruder]
step_pin: P2.13
dir_pin: P0.11
enable_pin: !P2.12
microsteps: 16
rotation_distance: 7.808 # measured
# rotation_distance: 8 # per BondTech
full_steps_per_rotation: 200 
nozzle_diameter: 0.400
filament_diameter: 1.750
max_extrude_only_distance: 650
sensor_pin: P0.23 # TH1 (TH0 is broken)
sensor_type: Generic 3950 #EPCOS 100K B57560G104F # Generic 3950 # NTC 100K beta 3950 #EPCOS 100K B57560G104F
min_temp: -273.15
max_temp: 500
#control: pid
#pid_Kp: 15.17
#pid_Ki: 1.02
#pid_Kd: 56.27
heater_pin: P2.7
pressure_advance: 0.2

[tmc2209 extruder]
uart_pin: P1.4
run_current: 0.500
interpolate: false 

[heater_fan hotend] 
pin: P2.4 
heater: extruder
heater_temp: 50.0
fan_speed: 1.0

# part cooling
[fan]      
pin: P2.3

[heater_bed]
heater_pin: P2.5
sensor_type: Generic 3950
sensor_pin: P0.25
min_temp: 0
max_temp: 115
#control: pid
#pid_Kp: 59.45   #same as the extruder enable and delete the save at the bottom. 
#pid_Ki: 11.8
#pid_Kd: 199.75

[probe]
pin: !P1.25 #Z_MIN
x_offset: 0
y_offset: 0
#z_offset: 0 
speed: 10
lift_speed: 5
samples: 3
samples_result: average
sample_retract_dist: 5
samples_tolerance: 0.02
samples_tolerance_retries: 5

[filament_switch_sensor filament]
pause_on_runout: True
switch_pin: P1.26


[delta_calibrate]
radius: 135
horizontal_move_z: 30
speed: 50

[bed_mesh]
speed: 150
horizontal_move_z: 25
mesh_radius: 125
mesh_origin: 0,0
round_probe_count: 17
algorithm: bicubic
bicubic_tension: 0.2

[mcu rpi]
serial: /tmp/klipper_host_mcu

[adxl345]
cs_pin: rpi:None

[resonance_tester]
accel_chip: adxl345
probe_points:
    0,0,20  # an example

[input_shaper]
shaper_freq_x: 44.2
shaper_type_x: mzv
shaper_freq_y: 50.6
shaper_type_y: ei

[endstop_phase]

[gcode_arcs]

[firmware_retraction]
retract_length: 5.5
retract_speed: 35
unretract_extra_length: 0
unretract_speed: 35

[virtual_sdcard]
path: /home/pi/gcode_files

[display_status]

[pause_resume]

[gcode_macro START_PRINT]
gcode:
  {% set BED_TEMP = params.BED_TEMP|default(60)|float %}
  {% set EXTRUDER_TEMP = params.EXTRUDER_TEMP|default(190)|float %}
  # Clear pasue state
  CLEAR_PAUSE
  # Start bed heating
  M140 S{BED_TEMP}
  # Use absolute coordinates
  G90
  # Reset extrusion distance
  G92 E0 
  # Use absolute extrution
  M82
  # Reset the G-Code Z offset (adjust Z offset if needed)
  SET_GCODE_OFFSET Z=0.10
  # Home the printer
  G28
  # Wait for bed to reach temperature
  M190 S{BED_TEMP}
  # Set and wait for nozzle to reach temperature
  M109 S{EXTRUDER_TEMP}
  # Move to arc start
  G1 X0 Y0 Z150
  G1 X-130 Y0 Z0.4 F5000
  # Extrude about 40 mm by printing a 90 degree arc
  G3 X0 Y-130 I130 Z0.3 E40 F2700
  # Reset extrusion distance
  G92 E0 
  # Lift and retract
  G1 E-1.5 F1800
  G0 Z0.5
  G1 E0 F300
  

[gcode_macro CANCEL_PRINT]
description: Cancel the actual running print
rename_existing: CANCEL_PRINT_BASE
gcode:
  TURN_OFF_HEATERS
  CLEAR_PAUSE
  SDCARD_RESET_FILE
  CANCEL_PRINT_BASE

#[gcode_macro CALIBRATE_PRESSURE_ADVANCE]
#gcode:
#  {% set BED_TEMP = params.BED_TEMP|default(60)|float %}
#  {% set EXTRUDER_TEMP = params.EXTRUDER_TEMP|default(190)|float %}
#  {% set FACTOR = params.FACTOR|default(0.020)|float %}
#  {% set feed_rate = 7800 %}
#  START_PRINT BED_TEMP={BED_TEMP} EXTRUDER_TEMP={EXTRUDER_TEMP}
#  SET_VELOCITY_LIMIT SQUARE_CORNER_VELOCITY=1 ACCEL=500
#  TUNING_TOWER COMMAND=SET_PRESSURE_ADVANCE PARAMETER=ADVANCE START=0 FACTOR={FACTOR}
#  SDCARD_PRINT_FILE FILENAME=tuning/square_tower_layer_03_line_04_speed_100.gcode

[gcode_macro TEST_DELTA_RESONANCE]
gcode:
  G28
  TEST_RESONANCES AXIS=0,1 OUTPUT=raw_data
  TEST_RESONANCES AXIS=-0.866025404,-0.5 OUTPUT=raw_data
  TEST_RESONANCES AXIS=0.866025404,-0.5 OUTPUT=raw_data


[gcode_macro CALIBRATE_ENDSTOP_PHASE]
gcode:
  SAVE_GCODE_STATE NAME=CALIBRATE_ENDSTOP_PHASE_STATE
  {% set feed_rate = 7800 %}
  G28 # home
  G90  # absolute movement
  ENDSTOP_PHASE_CALIBRATE
  
  G1 Z200 F{feed_rate}
  G1 X20 Y20 F{feed_rate}
  G28 # home
  G1 Z200 F{feed_rate}
  G1 X-20 Y20 F{feed_rate}
  G28 # home
  G1 Z200 F{feed_rate}
  G1 X20 Y-20 F{feed_rate}
  G28 # home
  G1 Z200 F{feed_rate}
  G1 X-20 Y-20 F{feed_rate}
  G28 # home

  G1 Z100 F{feed_rate}
  G1 X50 Y50 F{feed_rate}
  G28 # home
  G1 Z100 F{feed_rate}
  G1 X-50 Y50 F{feed_rate}
  G28 # home
  G1 Z100 F{feed_rate}
  G1 X50 Y-50 F{feed_rate}
  G28 # home
  G1 Z100 F{feed_rate}
  G1 X-50 Y-50 F{feed_rate}
  G28 # home

  G1 Z50 F{feed_rate}
  G1 X75 Y75 F{feed_rate}
  G28 # home
  G1 Z50 F{feed_rate}
  G1 X-75 Y75 F{feed_rate}
  G28 # home
  G1 Z50 F{feed_rate}
  G1 X75 Y-75 F{feed_rate}
  G28 # home
  G1 Z50 F{feed_rate}
  G1 X-75 Y-75 F{feed_rate}
  G28 # home

  ENDSTOP_PHASE_CALIBRATE STEPPER=stepper_a
  ENDSTOP_PHASE_CALIBRATE STEPPER=stepper_b
  ENDSTOP_PHASE_CALIBRATE STEPPER=stepper_c

  RESTORE_GCODE_STATE NAME=CALIBRATE_ENDSTOP_PHASE_STATE

# filament management
[gcode_macro UNLOAD_FILAMENT]
gcode:
  SAVE_GCODE_STATE NAME=UNLOAD_FILAMENT_STATE
  G91 # relative positioning
  M117 Heating...
  # heat up hotend to provided temp or 220 as default as that should work OK with most filaments.  
  M109 S{params.TEMP|default(220, true)} 
  M117 Unloading filament...
  G0 E50 F400 # purge 50mm 
  G0 E-50 F3000 # retract  
  G0 E-600 F500 # unload 60cm filament
  M117 Filament unloaded!
  RESTORE_GCODE_STATE NAME=UNLOAD_FILAMENT_STATE

[gcode_macro LOAD_FILAMENT]
gcode:
  SAVE_GCODE_STATE NAME=LOAD_FILAMENT_STATE
  G91 #relative positioning
  M117 Heating...
  # Heat up hotend to provided temp or 220 as default as that should work OK with most filaments.  
  M109 S{params.TEMP|default(220, true)} 
  M117 Loading filament...
  G0 E600 F1000 # feed 60cm filament
  G4 P1000 # wait for 1 second
  G0 E50 F200 # purge 50mm filament
  M400 # wait for purge to complete
  TURN_OFF_HEATERS
  M117 Filament loaded!
  RESTORE_GCODE_STATE NAME=LOAD_FILAMENT_STATE

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 19.053
#*# pid_ki = 0.726
#*# pid_kd = 125.034
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 72.002
#*# pid_ki = 1.661
#*# pid_kd = 780.323
#*#
#*# [probe]
#*# z_offset = 17.000
#*#
#*# [printer]
#*# delta_radius = 151.250634
#*#
#*# [stepper_a]
#*# angle = 210.097219
#*# arm_length = 315.000000
#*# position_endstop = 332.633609
#*#
#*# [stepper_b]
#*# angle = 329.987041
#*# arm_length = 315.000000
#*# position_endstop = 333.388923
#*#
#*# [stepper_c]
#*# angle = 90.000000
#*# arm_length = 315.000000
#*# position_endstop = 332.735365
#*#
#*# [endstop_phase stepper_a]
#*# trigger_phase = 33/512
#*#
#*# [endstop_phase stepper_b]
#*# trigger_phase = 503/512
#*#
#*# [endstop_phase stepper_c]
#*# trigger_phase = 332/512
#*#
#*# [delta_calibrate]
#*# height0 = 17.0
#*# height0_pos = 202004.333,202475.333,202082.333
#*# height1 = 17.0
#*# height1_pos = 250107.000,250475.000,177849.000
#*# height2 = 17.0
#*# height2_pos = 197928.333,278342.333,197913.333
#*# height3 = 17.0
#*# height3_pos = 178607.333,242233.333,241871.000
#*# height4 = 17.0
#*# height4_pos = 195856.000,196381.000,252779.000
#*# height5 = 17.0
#*# height5_pos = 234493.000,180288.000,234669.000
#*# height6 = 17.0
#*# height6_pos = 264253.000,197158.000,196744.000
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	  0.187853, 0.187853, 0.187853, 0.187853, 0.187853, 0.187853, 0.187853, 0.187853, 0.187853, 0.187853, 0.187853, 0.187853, 0.187853, 0.187853, 0.187853, 0.187853, 0.187853
#*# 	  0.220316, 0.220316, 0.220316, 0.220316, 0.220316, 0.220316, 0.214639, 0.200348, 0.183894, 0.149173, 0.100263, 0.075709, 0.075709, 0.075709, 0.075709, 0.075709, 0.075709
#*# 	  0.198831, 0.198831, 0.198831, 0.198831, 0.200906, 0.203475, 0.211937, 0.200937, 0.179204, 0.154711, 0.130034, 0.110380, 0.091674, 0.144695, 0.144695, 0.144695, 0.144695
#*# 	  0.166146, 0.166146, 0.166146, 0.202302, 0.219056, 0.226906, 0.223427, 0.211937, 0.190202, 0.164462, 0.148941, 0.120950, 0.100149, 0.121601, 0.256976, 0.256976, 0.256976
#*# 	  0.142297, 0.142297, 0.142297, 0.184497, 0.210191, 0.222484, 0.227482, 0.221527, 0.205012, 0.194322, 0.182844, 0.161856, 0.154619, 0.154722, 0.217782, 0.217782, 0.217782
#*# 	  0.113729, 0.113729, 0.155674, 0.184799, 0.206976, 0.214811, 0.211624, 0.210389, 0.221444, 0.213222, 0.195683, 0.180612, 0.166161, 0.157815, 0.165825, 0.233437, 0.233437
#*# 	  0.123104, 0.123104, 0.159278, 0.189928, 0.203133, 0.206234, 0.208109, 0.208693, 0.224462, 0.229181, 0.221466, 0.209302, 0.204777, 0.200107, 0.189799, 0.199807, 0.199807
#*# 	  0.150800, 0.150800, 0.182719, 0.195290, 0.198938, 0.195044, 0.195429, 0.203235, 0.222969, 0.228649, 0.227672, 0.207028, 0.211477, 0.200897, 0.195104, 0.203838, 0.203838
#*# 	  0.119185, 0.145128, 0.174763, 0.191919, 0.201582, 0.198470, 0.204224, 0.221907, 0.232320, 0.228636, 0.227862, 0.218186, 0.215648, 0.212646, 0.204807, 0.212148, 0.218423
#*# 	  0.165363, 0.165363, 0.187929, 0.207604, 0.213344, 0.212384, 0.217833, 0.244809, 0.239263, 0.230909, 0.223282, 0.222929, 0.221246, 0.207233, 0.197484, 0.203977, 0.203977
#*# 	  0.155487, 0.155487, 0.167448, 0.187563, 0.206760, 0.224034, 0.240623, 0.249805, 0.243810, 0.233832, 0.234253, 0.239173, 0.231444, 0.219385, 0.209747, 0.199772, 0.199772
#*# 	  0.175025, 0.175025, 0.192772, 0.206815, 0.217977, 0.234128, 0.245197, 0.255302, 0.240491, 0.234159, 0.241101, 0.228107, 0.221707, 0.206558, 0.195521, 0.192096, 0.192096
#*# 	  0.210143, 0.210143, 0.210143, 0.204761, 0.208528, 0.212949, 0.211369, 0.224546, 0.218779, 0.215125, 0.215002, 0.209573, 0.197799, 0.186018, 0.180553, 0.180553, 0.180553
#*# 	  0.231889, 0.231889, 0.231889, 0.219742, 0.215368, 0.206990, 0.204870, 0.215375, 0.207973, 0.197617, 0.188123, 0.162662, 0.151101, 0.144236, 0.138536, 0.138536, 0.138536
#*# 	  0.222526, 0.222526, 0.222526, 0.222526, 0.197980, 0.175484, 0.171512, 0.195739, 0.173984, 0.151558, 0.124452, 0.103212, 0.088141, 0.087403, 0.087403, 0.087403, 0.087403
#*# 	  0.198090, 0.198090, 0.198090, 0.198090, 0.198090, 0.198090, 0.206939, 0.200194, 0.171231, 0.136714, 0.097433, 0.062508, 0.062508, 0.062508, 0.062508, 0.062508, 0.062508
#*# 	  0.136974, 0.136974, 0.136974, 0.136974, 0.136974, 0.136974, 0.136974, 0.136974, 0.136974, 0.136974, 0.136974, 0.136974, 0.136974, 0.136974, 0.136974, 0.136974, 0.136974
#*# tension = 0.2
#*# min_x = -124.96
#*# algo = bicubic
#*# y_count = 17
#*# mesh_y_pps = 2
#*# min_y = -124.96
#*# x_count = 17
#*# max_y = 124.96
#*# mesh_x_pps = 2
#*# max_x = 124.96
