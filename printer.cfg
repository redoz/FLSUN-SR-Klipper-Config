###Flsun Super Racer printer config####

[mcu]
serial: /dev/serial/by-id/usb-Klipper_lpc1769_0E80FF0AC0846AAF99CA555EC02000F5-if00

[printer]
kinematics: delta
max_velocity: 7000
max_accel: 4800
max_z_velocity: 2000
minimum_z_position: -5
square_corner_velocity: 15.0
#delta_radius: 150
print_radius: 131 # print area is 260mm diameter


###Stepper X config###
[stepper_a]
step_pin: P2.2
dir_pin: P2.6
enable_pin: !P2.1
microsteps: 128
rotation_distance: 40
endstop_pin: P1.29
#position_endstop: 336
#arm_length: 315.0

homing_speed: 80 # can bump this to maybe 90
second_homing_speed: 5
homing_retract_dist: 5.0
homing_retract_speed:10

[tmc2209 stepper_a]
uart_pin: P1.10
run_current: 0.850
interpolate: false


###Stepper Y config###
[stepper_b]
step_pin: P0.19
dir_pin: P0.20
enable_pin: !P2.8
microsteps: 128
rotation_distance: 40
endstop_pin: P1.28 
#position_endstop: 336
#arm_length: 315.0

[tmc2209 stepper_b]
uart_pin: P1.9
run_current: 0.850
interpolate: false


###Stepper Z config###
[stepper_c]
step_pin: P0.22
dir_pin: P2.11
enable_pin: !P0.21
microsteps: 128
rotation_distance: 40
endstop_pin: P1.27  
#position_endstop: 336
#arm_length: 315.0

[tmc2209 stepper_c]
uart_pin: P1.8
run_current: 0.850
interpolate: false

[extruder]
step_pin: P2.13
dir_pin: P0.11
enable_pin: !P2.12
microsteps: 16
rotation_distance: 7.808 # measured
# rotation_distance: 8 # per BondTech
full_steps_per_rotation: 200 
nozzle_diameter: 0.400
filament_diameter: 1.750
max_extrude_only_distance: 650
sensor_pin: P0.23 # TH1 (TH0 is broken)
sensor_type: Generic 3950 #EPCOS 100K B57560G104F # Generic 3950 # NTC 100K beta 3950 #EPCOS 100K B57560G104F
min_temp: -273.15
max_temp: 500
#control: pid
#pid_Kp: 15.17
#pid_Ki: 1.02
#pid_Kd: 56.27
heater_pin: P2.7
pressure_advance: 0.2

[tmc2209 extruder]
uart_pin: P1.4
run_current: 0.500
interpolate: false 

[heater_fan hotend] 
pin: P2.4 
heater: extruder
heater_temp: 50.0
fan_speed: 1.0

# part cooling
[fan]      
pin: P2.3

[heater_bed]
heater_pin: P2.5
sensor_type: Generic 3950
sensor_pin: P0.25
min_temp: 0
max_temp: 115
#control: pid
#pid_Kp: 59.45   #same as the extruder enable and delete the save at the bottom. 
#pid_Ki: 11.8
#pid_Kd: 199.75

[probe]
pin: !P1.25 #Z_MIN
x_offset: 0
y_offset: 0
#z_offset: 0 
speed: 10
lift_speed: 5
samples: 3
samples_result: average
sample_retract_dist: 5
samples_tolerance: 0.02
samples_tolerance_retries: 5

[filament_switch_sensor filament]
pause_on_runout: True
switch_pin: P1.26


[delta_calibrate]
radius: 135
horizontal_move_z: 30
speed: 50

[bed_mesh]
speed: 150
horizontal_move_z: 25
mesh_radius: 125
mesh_origin: 0,0
round_probe_count: 17
algorithm: bicubic
bicubic_tension: 0.2

[mcu rpi]
serial: /tmp/klipper_host_mcu

[adxl345]
cs_pin: rpi:None

[resonance_tester]
accel_chip: adxl345
probe_points: 0,0,20  # an example

[input_shaper]
shaper_freq_x: 44.2
shaper_type_x: mzv
shaper_freq_y: 50.6
shaper_type_y: ei

[endstop_phase]

[gcode_arcs]

[firmware_retraction]
retract_length: 1.75
retract_speed: 35
unretract_extra_length: 0
unretract_speed: 35

[virtual_sdcard]
path: /home/pi/gcode_files

[display_status]

[pause_resume]

[respond]

[gcode_macro START_PRINT]
gcode:
  {% set BED_TEMP = params.BED_TEMP|default(60)|float %}
  {% set EXTRUDER_TEMP = params.EXTRUDER_TEMP|default(190)|float %}
  # Clear pasue state
  CLEAR_PAUSE
  # Start bed heating
  M140 S{BED_TEMP}
  
  # Reset the G-Code Z offset (adjust Z offset if needed)
  SET_GCODE_OFFSET Z=0.0
  # Home the printer
  G28
  # Wait for bed to reach temperature
  M190 S{BED_TEMP}
  # Set and wait for nozzle to reach temperature
  M109 S{EXTRUDER_TEMP}
  ARC_STRIPE

[gcode_macro ARC_STRIPE]
gcode:
  # Use absolute coordinates
  G90
  # Reset extrusion distance
  G92 E0 
  # Use absolute extrution
  M82
  # Move to arc start
  G1 X0 Y0 Z150
  G1 X-130 Y0 Z0.4 F5000
  # Extrude about 40 mm by printing a 90 degree arc
  G3 X0 Y-130 I130 Z0.3 E40 F2700
  # Reset extrusion distance
  G92 E0 
  # Lift and retract
  G1 E-1.5 F1800
  G0 Z0.5
  G1 E0 F300


[gcode_macro CANCEL_PRINT]
description: Cancel the actual running print
rename_existing: CANCEL_PRINT_BASE
gcode:
  TURN_OFF_HEATERS
  CLEAR_PAUSE
  SDCARD_RESET_FILE
  CANCEL_PRINT_BASE

[include macro_*.cfg]

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 19.053
#*# pid_ki = 0.726
#*# pid_kd = 125.034
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 72.002
#*# pid_ki = 1.661
#*# pid_kd = 780.323
#*#
#*# [probe]
#*# z_offset = 17.000
#*#
#*# [printer]
#*# delta_radius = 151.064287
#*#
#*# [stepper_a]
#*# angle = 210.056395
#*# arm_length = 315.000000
#*# position_endstop = 332.374490
#*#
#*# [stepper_b]
#*# angle = 330.009686
#*# arm_length = 315.000000
#*# position_endstop = 333.141669
#*#
#*# [stepper_c]
#*# angle = 90.000000
#*# arm_length = 315.000000
#*# position_endstop = 332.471471
#*#
#*# [endstop_phase stepper_a]
#*# trigger_phase = 34/512
#*#
#*# [endstop_phase stepper_b]
#*# trigger_phase = 504/512
#*#
#*# [endstop_phase stepper_c]
#*# trigger_phase = 331/512
#*#
#*# [delta_calibrate]
#*# height0 = 17.0
#*# height0_pos = 201842.333,202326.333,201908.333
#*# height1 = 17.0
#*# height1_pos = 250017.000,250421.667,177730.667
#*# height2 = 17.0
#*# height2_pos = 197786.333,278333.333,197790.333
#*# height3 = 17.0
#*# height3_pos = 178483.333,242195.333,241787.333
#*# height4 = 17.0
#*# height4_pos = 195728.333,196252.333,252668.333
#*# height5 = 17.0
#*# height5_pos = 234437.667,180164.667,234566.667
#*# height6 = 17.0
#*# height6_pos = 264193.000,197027.000,196601.000
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	  0.025307, 0.025307, 0.025307, 0.025307, 0.025307, 0.025307, 0.025307, 0.025307, 0.025307, 0.025307, 0.025307, 0.025307, 0.025307, 0.025307, 0.025307, 0.025307, 0.025307
#*# 	  0.057458, 0.057458, 0.057458, 0.057458, 0.057458, 0.057458, 0.050269, 0.027441, 0.013761, -0.011584, -0.053195, -0.075665, -0.075665, -0.075665, -0.075665, -0.075665, -0.075665
#*# 	  0.041145, 0.041145, 0.041145, 0.041145, 0.038065, 0.031452, 0.026990, 0.015602, -0.002700, -0.021177, -0.040261, -0.051101, -0.062646, -0.063902, -0.063902, -0.063902, -0.063902
#*# 	  0.005958, 0.005958, 0.005958, 0.031355, 0.038320, 0.035178, 0.027748, 0.009914, -0.003777, -0.026362, -0.038725, -0.056780, -0.063310, -0.058811, -0.058527, -0.058527, -0.058527
#*# 	  -0.029377, -0.029377, -0.029377, -0.005004, 0.017093, 0.019376, 0.019813, 0.009754, -0.002757, -0.009184, -0.018281, -0.036186, -0.030588, -0.025885, -0.023208, -0.023208, -0.023208
#*# 	  -0.061813, -0.061813, -0.033709, -0.015471, -0.008243, -0.006172, -0.007108, -0.012766, -0.004063, -0.005543, -0.018974, -0.034872, -0.040298, -0.030097, -0.025306, -0.011344, -0.011344
#*# 	  -0.072321, -0.072321, -0.044545, -0.021009, -0.016383, -0.023055, -0.021205, -0.024030, -0.011826, 0.003812, -0.009425, -0.021088, -0.012514, -0.004232, -0.001511, 0.011118, 0.011118
#*# 	  -0.056173, -0.056173, -0.036433, -0.027120, -0.027907, -0.040470, -0.042812, -0.031870, -0.016929, -0.008631, -0.014657, -0.025972, -0.014391, -0.014223, -0.007420, 0.016165, 0.016165
#*# 	  -0.092156, -0.070229, -0.051434, -0.034656, -0.030678, -0.039973, -0.033004, -0.019041, -0.008811, -0.010338, -0.015232, -0.014993, -0.006425, -0.002874, 0.004936, 0.017257, 0.044872
#*# 	  -0.055930, -0.055930, -0.036585, -0.019368, -0.020243, -0.023815, -0.017991, 0.002302, -0.004124, -0.013036, -0.014866, -0.010904, -0.007273, -0.010806, -0.008510, 0.011986, 0.011986
#*# 	  -0.056076, -0.056076, -0.051456, -0.034950, -0.029293, -0.012101, 0.002117, 0.012312, 0.002134, -0.003534, -0.002577, 0.004139, 0.005975, 0.002307, 0.004756, 0.009242, 0.009242
#*# 	  -0.030938, -0.030938, -0.019170, -0.013511, -0.009626, 0.000168, 0.011370, 0.016597, 0.003509, 0.000761, 0.002552, -0.001728, 0.003307, 0.001271, -0.005366, 0.005984, 0.005984
#*# 	  0.009883, 0.009883, 0.009883, -0.009678, -0.017676, -0.020461, -0.021083, -0.003001, -0.007440, -0.005404, -0.008755, -0.013162, -0.016422, -0.010781, -0.005792, -0.005792, -0.005792
#*# 	  0.038555, 0.038555, 0.038555, 0.020662, 0.001496, -0.017837, -0.005301, -0.004056, -0.006637, -0.017808, -0.035591, -0.050537, -0.049231, -0.041872, -0.032117, -0.032117, -0.032117
#*# 	  0.029703, 0.029703, 0.029703, 0.029703, 0.000477, -0.026589, -0.033752, -0.008078, -0.027250, -0.052384, -0.076926, -0.089181, -0.092727, -0.083591, -0.083591, -0.083591, -0.083591
#*# 	  0.011410, 0.011410, 0.011410, 0.011410, 0.011410, 0.011410, 0.031795, 0.013765, -0.020403, -0.055546, -0.085237, -0.107444, -0.107444, -0.107444, -0.107444, -0.107444, -0.107444
#*# 	  -0.033272, -0.033272, -0.033272, -0.033272, -0.033272, -0.033272, -0.033272, -0.033272, -0.033272, -0.033272, -0.033272, -0.033272, -0.033272, -0.033272, -0.033272, -0.033272, -0.033272
#*# tension = 0.2
#*# min_x = -124.96
#*# algo = bicubic
#*# y_count = 17
#*# mesh_y_pps = 2
#*# min_y = -124.96
#*# x_count = 17
#*# max_y = 124.96
#*# mesh_x_pps = 2
#*# max_x = 124.96
